/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package org.dynamics;

import org.dynamics.db.Db;
import org.dynamics.db.LevelDb;
import org.dynamics.model.FileImport;
import org.dynamics.model.Item;
import org.dynamics.model.Person;
import org.dynamics.reader.CsvFileReader;
import org.dynamics.reader.Reader;
import org.dynamics.ui.BouteFrame;
import org.dynamics.ui.CommonFrame;
import org.dynamics.ui.EventListFrame;
import org.dynamics.ui.FindFrame;
import org.dynamics.util.Utility;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.IOException;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

public class Library  extends CommonFrame {
    private Map<String, Map<String, ActionListener>> men = new LinkedHashMap<>();
    private Map<String, ActionListener> fileMenuItems = new LinkedHashMap<>();
    private Map<String, ActionListener> bouteMenuItems = new LinkedHashMap<>();
    private Map<String, ActionListener> contactUs = new LinkedHashMap<>();
    private Db db = new LevelDb();
    public Library(String title) throws UnsupportedLookAndFeelException, ClassNotFoundException, InstantiationException, IllegalAccessException, IOException {
        super(title);
        this.commonNorthPanel();
        contactUs.put("Contact",(ActionEvent e)->{
            JFrame jf = new JFrame("Contact Us");
            jf.setTitle("Contact Us");
            jf.setVisible(true);
            jf.getContentPane().setBackground(Color.WHITE);
            jf.setSize(new Dimension(300,150));
            jf.setResizable(false);
            jf.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
            JPanel j = new JPanel();
            JLabel cont = new JLabel("<html>Dynamics 101 MMA");
            cont.setFont(new Font("Serif",Font.BOLD,25));
            j.add(cont);
            jf.add(j);
        });
        fileMenuItems.put("New Players", (ActionEvent e)->{
            String reportTitle = JOptionPane.showInputDialog("Please Enter the Player list name");
            if(reportTitle.toString().isEmpty()){
                alert("Please enter valid Report title");
                return;
            }
            FileImport fileImport = new FileImport();
            fileImport.setName(reportTitle);
            fileImport.setImportedBy(System.getProperty("user.name"));
            fileImport.setId(Utility.getRandom());
            fileImport.setImportedTime(LocalDateTime.now());
            try{
                db.insert("File_"+fileImport.getId(),fileImport);
                FindFrame findFrame = new FindFrame("Find",fileImport.getPerson(),fileImport);
                findFrame.northpanel();
                findFrame.addDetails(db);
                findFrame.southPanel(db);
            }catch (Exception es){
                alert(es.getMessage());
                es.printStackTrace();
            }
        });
        fileMenuItems.put("Search Players",(ActionEvent e)->{
            try {
                List<String> fileImports = db.keyFilterBy("File_");
                JComboBox<Item> comboBox = new JComboBox<>();

                 fileImports.stream().map(a->{
                    try {
                        FileImport fileImport  = db.findObject(a);
                        comboBox.addItem(new Item(fileImport.getId(),fileImport.getName()));
                    } catch (Exception ex) {
                        ex.printStackTrace();
                        alert(ex.getMessage());
                    }
                    return null;
                }).collect(Collectors.toList());

                Integer result = confirmation("Please select imported file.",()->comboBox);
                if(result==JOptionPane.YES_OPTION){
                    Item keySelected = (Item)comboBox.getSelectedItem();
                    if(keySelected.getId()!=0){
                        String fileKey = "File_"+keySelected.getId().toString();
                        FileImport fileImport = db.findObject(fileKey);
                        FindFrame findFrame = new FindFrame("Find",fileImport.getPerson(),fileImport);
                        findFrame.northpanel();
                        findFrame.addDetails(db);
                        findFrame.southPanel(db);
                    }else {
                        alert("Please select valid file Id");
                    }
                }

            } catch (Exception ex) {
                ex.printStackTrace();
                alert(ex.getMessage());
            }
        });
        bouteMenuItems.put("Search Events",(ActionEvent e)->{
            try {
                BouteFrame bouteFrame = new BouteFrame("Find Events",db);
                bouteFrame.northPanel();
                bouteFrame.centerPanel();
                bouteFrame.southPanel();
            } catch (Exception ex) {
                ex.printStackTrace();
                alert(ex.getMessage());
            }

        });
        bouteMenuItems.put("List Events", (ActionEvent e)->{
            try {
                EventListFrame eventListFrame = new EventListFrame("List Events");
                eventListFrame.northPanel(db);
                eventListFrame.listEvents(db);
                eventListFrame.southPanel();
            } catch (Exception ex) {
                ex.printStackTrace();
                alert(ex.getMessage());
            }
        });


        fileMenuItems.put("Import Players",(ActionEvent e)->{
            try {
                fileChooser().ifPresent(filePath->{
                    Reader<Person> reader = null;
                    try {
                        FileImport fileImport = new FileImport();
                        reader = new CsvFileReader(filePath,fileImport);
                        List<Person> persons =  reader.read();
                        db.insert("File_"+fileImport.getId(),fileImport);
                        alert("Total : "+persons.size()+" Uploaded Successfully...!");
                    } catch (Exception ex) {
                        ex.printStackTrace();
                        alert(ex.getMessage());
                    }
                });

            } catch (Exception ex) {
                ex.printStackTrace();
                alert(ex.getMessage());
            }
        });

        men.put("Player List", fileMenuItems);
        men.put("Event", bouteMenuItems);
        men.put("Contact Us",contactUs);
        super.menuBar(men);
    }
    public static void main(String args[]) throws UnsupportedLookAndFeelException, ClassNotFoundException, InstantiationException, IllegalAccessException, IOException {
        Library library = new Library("Dynamcis 101 MMA");
    }
}
